<!-- pages/analysis/analysis.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ—¶é—´é€‰æ‹©å™¨ -->
  <view class="time-selector card">
    <view class="selector-tabs">
      <view 
        wx:for="{{timePeriods}}" 
        wx:key="value"
        class="tab-item {{currentPeriod === item.value ? 'active' : ''}}"
        bindtap="switchPeriod"
        data-period="{{item.value}}"
      >
        {{item.label}}
      </view>
    </view>
    
    <!-- è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ -->
    <view class="custom-range" wx:if="{{currentPeriod === 'custom'}}">
      <picker 
        mode="date" 
        value="{{startDate}}" 
        bindchange="onStartDateChange"
        class="date-picker"
      >
        <view class="picker-text">{{startDate || 'å¼€å§‹æ—¥æœŸ'}}</view>
      </picker>
      <text class="date-separator">è‡³</text>
      <picker 
        mode="date" 
        value="{{endDate}}" 
        bindchange="onEndDateChange"
        class="date-picker"
      >
        <view class="picker-text">{{endDate || 'ç»“æŸæ—¥æœŸ'}}</view>
      </picker>
    </view>
    
    <view class="period-summary">
      <text class="summary-text">{{periodSummary}}</text>
    </view>
  </view>

  <!-- æƒ…ç»ªè¶‹åŠ¿å›¾ -->
  <view class="trend-chart card">
    <view class="card-title">
      <text>æƒ…ç»ªè¶‹åŠ¿</text>
      <view class="chart-controls">
        <view 
          class="control-item {{chartType === 'line' ? 'active' : ''}}"
          bindtap="switchChartType"
          data-type="line"
        >
          ğŸ“ˆ
        </view>
        <view 
          class="control-item {{chartType === 'bar' ? 'active' : ''}}"
          bindtap="switchChartType"
          data-type="bar"
        >
          ğŸ“Š
        </view>
      </view>
    </view>
    
    <view class="chart-container">
      <canvas 
        canvas-id="trendChart"
        class="chart-canvas"
        bindtouchstart="onChartTouch"
      ></canvas>
      
      <view class="chart-empty" wx:if="{{!hasChartData}}">
        <image class="empty-icon" src="../../assets/icons/chart-empty.png" />
        <text class="empty-text">æš‚æ— æ•°æ®ï¼Œå¿«å»è®°å½•å¿ƒæƒ…å§ ğŸ˜Š</text>
      </view>
    </view>
    
    <view class="chart-legend" wx:if="{{hasChartData}}">
      <view 
        wx:for="{{chartLegend}}" 
        wx:key="label"
        class="legend-item"
      >
        <view class="legend-color" style="background-color: {{item.color}}"></view>
        <text class="legend-label">{{item.label}}</text>
      </view>
    </view>
  </view>

  <!-- æƒ…ç»ªåˆ†å¸ƒç»Ÿè®¡ -->
  <view class="emotion-stats card">
    <view class="card-title">æƒ…ç»ªåˆ†å¸ƒ</view>
    
    <view class="stats-overview">
      <view class="overview-item">
        <view class="overview-number">{{totalRecords}}</view>
        <view class="overview-label">æ€»è®°å½•æ•°</view>
      </view>
      <view class="overview-item">
        <view class="overview-number">{{averageIntensity}}</view>
        <view class="overview-label">å¹³å‡å¼ºåº¦</view>
      </view>
      <view class="overview-item">
        <view class="overview-number">{{streakDays}}</view>
        <view class="overview-label">è¿ç»­å¤©æ•°</view>
      </view>
    </view>

    <!-- æƒ…ç»ªåœ†ç¯å›¾ -->
    <view class="pie-chart-container">
      <canvas 
        canvas-id="emotionPieChart"
        class="pie-chart"
      ></canvas>
      
      <view class="pie-center-info">
        <view class="center-number">{{dominantPercentage}}%</view>
        <view class="center-label">{{dominantEmotion}}</view>
      </view>
    </view>

    <!-- æƒ…ç»ªåˆ—è¡¨ -->
    <view class="emotion-list">
      <view 
        wx:for="{{emotionStats}}" 
        wx:key="emotion"
        class="emotion-item"
      >
        <view class="emotion-info">
          <text class="emotion-emoji">{{item.emoji}}</text>
          <text class="emotion-name">{{item.emotion}}</text>
        </view>
        <view class="emotion-progress">
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{item.percentage}}%; background-color: {{item.color}}"
            ></view>
          </view>
          <view class="progress-text">
            <text class="progress-count">{{item.count}}æ¬¡</text>
            <text class="progress-percent">{{item.percentage}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- AI æ·±åº¦æ´å¯Ÿ -->
  <view class="ai-insights card">
    <view class="card-title">
      <image class="ai-icon" src="../../assets/icons/ai.png" />
      <text>AI æ·±åº¦æ´å¯Ÿ</text>
      <view class="insight-loading" wx:if="{{insightLoading}}">
        <view class="loading loading-small"></view>
      </view>
    </view>

    <view class="insights-list" wx:if="{{aiInsights.length > 0}}">
      <view 
        wx:for="{{aiInsights}}" 
        wx:key="id"
        class="insight-item"
      >
        <view class="insight-header">
          <image class="insight-icon" src="{{item.icon}}" />
          <text class="insight-title">{{item.title}}</text>
          <view class="insight-confidence">{{item.confidence}}%</view>
        </view>
        <view class="insight-content">{{item.content}}</view>
        <view class="insight-actions" wx:if="{{item.actions}}">
          <text 
            wx:for="{{item.actions}}" 
            wx:for-item="action"
            wx:key="*this"
            class="action-link"
            bindtap="handleInsightAction"
            data-action="{{action}}"
          >
            {{action}}
          </text>
        </view>
      </view>
    </view>

    <view class="insight-empty" wx:if="{{!insightLoading && aiInsights.length === 0}}">
      <text>éœ€è¦æ›´å¤šæ•°æ®æ¥ç”Ÿæˆæ·±åº¦æ´å¯Ÿ</text>
    </view>
  </view>

  <!-- æ¨¡å¼è¯†åˆ« -->
  <view class="pattern-analysis card">
    <view class="card-title">æ¨¡å¼è¯†åˆ«</view>
    
    <view class="pattern-tabs">
      <view 
        wx:for="{{patternTypes}}" 
        wx:key="value"
        class="pattern-tab {{currentPatternType === item.value ? 'active' : ''}}"
        bindtap="switchPatternType"
        data-type="{{item.value}}"
      >
        {{item.label}}
      </view>
    </view>

    <view class="patterns-list">
      <!-- æ—¶é—´æ¨¡å¼ -->
      <view class="pattern-section" wx:if="{{currentPatternType === 'time'}}">
        <view 
          wx:for="{{timePatterns}}" 
          wx:key="id"
          class="pattern-item"
        >
          <view class="pattern-icon">ğŸ•</view>
          <view class="pattern-content">
            <view class="pattern-title">{{item.title}}</view>
            <view class="pattern-description">{{item.description}}</view>
            <view class="pattern-confidence">ç½®ä¿¡åº¦: {{item.confidence}}%</view>
          </view>
        </view>
      </view>

      <!-- è§¦å‘æ¨¡å¼ -->
      <view class="pattern-section" wx:if="{{currentPatternType === 'trigger'}}">
        <view 
          wx:for="{{triggerPatterns}}" 
          wx:key="id"
          class="pattern-item"
        >
          <view class="pattern-icon">âš¡</view>
          <view class="pattern-content">
            <view class="pattern-title">{{item.title}}</view>
            <view class="pattern-description">{{item.description}}</view>
            <view class="pattern-tags">
              <text 
                wx:for="{{item.tags}}" 
                wx:for-item="tag"
                wx:key="*this"
                class="pattern-tag"
              >
                {{tag}}
              </text>
            </view>
          </view>
        </view>
      </view>

      <!-- å…³è”æ¨¡å¼ -->
      <view class="pattern-section" wx:if="{{currentPatternType === 'correlation'}}">
        <view 
          wx:for="{{correlationPatterns}}" 
          wx:key="id"
          class="pattern-item"
        >
          <view class="pattern-icon">ğŸ”—</view>
          <view class="pattern-content">
            <view class="pattern-title">{{item.title}}</view>
            <view class="pattern-description">{{item.description}}</view>
            <view class="correlation-strength">
              <text>å…³è”å¼ºåº¦: </text>
              <view class="strength-bar">
                <view 
                  class="strength-fill" 
                  style="width: {{item.strength}}%"
                ></view>
              </view>
              <text>{{item.strength}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="pattern-empty" wx:if="{{currentPatterns.length === 0}}">
      <image class="empty-icon" src="../../assets/icons/pattern-empty.png" />
      <text class="empty-text">æš‚æœªå‘ç°æ˜æ˜¾æ¨¡å¼ï¼Œç»§ç»­è®°å½•ä¼šæœ‰æ›´å¤šå‘ç°</text>
    </view>
  </view>

  <!-- æ”¹å–„å»ºè®® -->
  <view class="improvement-suggestions card">
    <view class="card-title">ä¸ªæ€§åŒ–å»ºè®®</view>
    
    <view class="suggestions-list">
      <view 
        wx:for="{{suggestions}}" 
        wx:key="id"
        class="suggestion-item"
      >
        <view class="suggestion-header">
          <image class="suggestion-icon" src="{{item.icon}}" />
          <view class="suggestion-info">
            <view class="suggestion-title">{{item.title}}</view>
            <view class="suggestion-priority">{{item.priority}}</view>
          </view>
          <view class="suggestion-score">{{item.score}}/10</view>
        </view>
        <view class="suggestion-content">{{item.description}}</view>
        <view class="suggestion-actions">
          <button 
            class="btn btn-outline btn-small mr-sm"
            bindtap="dismissSuggestion"
            data-id="{{item.id}}"
          >
            æš‚ä¸éœ€è¦
          </button>
          <button 
            class="btn btn-primary btn-small"
            bindtap="applySuggestion"
            data-suggestion="{{item}}"
          >
            ç«‹å³å°è¯•
          </button>
        </view>
      </view>
    </view>

    <view class="suggestion-empty" wx:if="{{suggestions.length === 0}}">
      <text>åŸºäºæ‚¨çš„æƒ…ç»ªæ¨¡å¼ï¼Œæš‚æ— ç‰¹åˆ«å»ºè®®</text>
    </view>
  </view>

  <!-- å¯¼å‡ºåˆ†äº« -->
  <view class="export-section card">
    <view class="card-title">åˆ†äº«ä¸å¯¼å‡º</view>
    
    <view class="export-options">
      <button 
        class="btn btn-outline export-btn"
        bindtap="generateReport"
      >
        <image class="btn-icon" src="../../assets/icons/report.png" />
        ç”ŸæˆæŠ¥å‘Š
      </button>
      
      <button 
        class="btn btn-outline export-btn"
        bindtap="shareToFriends"
      >
        <image class="btn-icon" src="../../assets/icons/share.png" />
        åˆ†äº«æˆé•¿
      </button>
      
      <button 
        class="btn btn-outline export-btn"
        bindtap="exportData"
      >
        <image class="btn-icon" src="../../assets/icons/download.png" />
        å¯¼å‡ºæ•°æ®
      </button>
    </view>
    
    <view class="privacy-note">
      <image class="privacy-icon" src="../../assets/icons/shield.png" />
      <text>æ‚¨çš„æ•°æ®éšç§å—åˆ°ä¸¥æ ¼ä¿æŠ¤ï¼Œåˆ†äº«å†…å®¹å·²åŒ¿ååŒ–å¤„ç†</text>
    </view>
  </view>
</view>

<!-- æŠ¥å‘Šç”Ÿæˆå¼¹çª— -->
<view class="modal-overlay" wx:if="{{showReportModal}}" bindtap="hideReportModal">
  <view class="modal-content report-modal" catchtap="">
    <view class="modal-header">
      <view class="modal-title">æƒ…ç»ªåˆ†ææŠ¥å‘Š</view>
      <view class="modal-close" bindtap="hideReportModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="report-preview">
        <canvas canvas-id="reportPreview" class="report-canvas"></canvas>
      </view>
      <view class="report-options">
        <view class="option-group">
          <view class="option-label">æŠ¥å‘Šç±»å‹</view>
          <view class="option-tabs">
            <view 
              wx:for="{{reportTypes}}" 
              wx:key="value"
              class="option-tab {{selectedReportType === item.value ? 'active' : ''}}"
              bindtap="selectReportType"
              data-type="{{item.value}}"
            >
              {{item.label}}
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="modal-actions">
      <button class="btn btn-outline mr-sm" bindtap="hideReportModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="confirmReport">ç”ŸæˆæŠ¥å‘Š</button>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{isLoading}}">
  <view class="loading-content">
    <view class="loading"></view>
    <text>{{loadingText}}</text>
  </view>
</view>
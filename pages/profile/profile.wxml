<!-- pages/profile/profile.wxml -->
<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card card">
    <view class="user-info" wx:if="{{userInfo}}">
      <image class="user-avatar" src="{{userInfo.avatarUrl || defaultAvatar}}" />
      <view class="user-details">
        <view class="user-name">{{userInfo.nickName || 'æœªè®¾ç½®æ˜µç§°'}}</view>
        <view class="user-stats">
          <text class="stat-item">è®°å½• {{totalRecords}} å¤©</text>
          <text class="stat-separator">Â·</text>
          <text class="stat-item">è¿ç»­ {{streakDays}} å¤©</text>
        </view>
        <view class="user-level">
          <text class="level-text">{{userLevel.name}}</text>
          <view class="level-progress">
            <view 
              class="level-progress-fill" 
              style="width: {{userLevel.progress}}%"
            ></view>
          </view>
        </view>
      </view>
      <view class="user-actions">
        <view class="action-btn" bindtap="editProfile">
          <image class="action-icon" src="../../assets/icons/edit.png" />
        </view>
      </view>
    </view>
    
    <!-- æœªç™»å½•çŠ¶æ€ -->
    <view class="login-prompt" wx:if="{{!userInfo}}">
      <image class="login-avatar" src="../../assets/icons/user-placeholder.png" />
      <view class="login-text">
        <view class="login-title">ç™»å½•ä½“éªŒæ›´å¤šåŠŸèƒ½</view>
        <view class="login-desc">æ•°æ®åŒæ­¥Â·ä¸ªæ€§åŒ–æ¨èÂ·æˆé•¿è®°å½•</view>
      </view>
      <button class="btn btn-primary" bindtap="loginUser">å¾®ä¿¡ç™»å½•</button>
    </view>
  </view>

  <!-- æˆå°±å¾½ç«  -->
  <view class="achievements card" wx:if="{{achievements.length > 0}}">
    <view class="card-title">
      <text>æˆå°±å¾½ç« </text>
      <text class="achievement-count">{{achievements.length}}/{{totalAchievements}}</text>
    </view>
    
    <view class="achievement-grid">
      <view 
        wx:for="{{achievements}}" 
        wx:key="id"
        class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}"
        bindtap="viewAchievement"
        data-achievement="{{item}}"
      >
        <image class="achievement-icon" src="{{item.icon}}" onerror="handleImageError" />
        <view class="achievement-name">{{item.name}}</view>
        <view class="achievement-progress" wx:if="{{!item.unlocked && item.progress}}">
          {{item.current}}/{{item.target}}
        </view>
      </view>
    </view>
    
    <view class="view-all-achievements" bindtap="viewAllAchievements">
      <text>æŸ¥çœ‹å…¨éƒ¨æˆå°±</text>
      <text class="arrow">â€º</text>
    </view>
  </view>

  <!-- æ•°æ®æ¦‚è§ˆ -->
  <view class="data-overview card">
    <view class="card-title">æ•°æ®æ¦‚è§ˆ</view>
    
    <view class="overview-grid">
      <view class="overview-item" bindtap="viewDetailData" data-type="records">
        <view class="overview-icon">ğŸ“Š</view>
        <view class="overview-number">{{totalRecords}}</view>
        <view class="overview-label">æ€»è®°å½•æ•°</view>
      </view>
      
      <view class="overview-item" bindtap="viewDetailData" data-type="days">
        <view class="overview-icon">ğŸ“…</view>
        <view class="overview-number">{{activeDays}}</view>
        <view class="overview-label">æ´»è·ƒå¤©æ•°</view>
      </view>
      
      <view class="overview-item" bindtap="viewDetailData" data-type="streak">
        <view class="overview-icon">ğŸ”¥</view>
        <view class="overview-number">{{maxStreak}}</view>
        <view class="overview-label">æœ€é•¿è¿ç»­</view>
      </view>
      
      <view class="overview-item" bindtap="viewDetailData" data-type="mood">
        <view class="overview-icon">ğŸ˜Š</view>
        <view class="overview-number">{{averageMood}}</view>
        <view class="overview-label">å¹³å‡å¿ƒæƒ…</view>
      </view>
    </view>
  </view>

  <!-- å¿«é€ŸåŠŸèƒ½ -->
  <view class="quick-actions card">
    <view class="card-title">å¿«é€ŸåŠŸèƒ½</view>
    
    <view class="action-list">
      <view class="action-row">
        <view class="action-item" bindtap="exportData">
          <image class="action-icon" src="../../assets/icons/export.png" />
          <view class="action-info">
            <view class="action-name">å¯¼å‡ºæ•°æ®</view>
            <view class="action-desc">å¯¼å‡ºæ‚¨çš„æƒ…ç»ªè®°å½•æ•°æ®</view>
          </view>
          <text class="action-arrow">â€º</text>
        </view>
      </view>
      
      <view class="action-row">
        <view class="action-item" bindtap="shareApp">
          <image class="action-icon" src="../../assets/icons/share.png" />
          <view class="action-info">
            <view class="action-name">åˆ†äº«åº”ç”¨</view>
            <view class="action-desc">æ¨èç»™æœ‹å‹ä½¿ç”¨</view>
          </view>
          <text class="action-arrow">â€º</text>
        </view>
      </view>
      
      <view class="action-row">
        <view class="action-item" bindtap="backupData">
          <image class="action-icon" src="../../assets/icons/backup.png" />
          <view class="action-info">
            <view class="action-name">å¤‡ä»½æ•°æ®</view>
            <view class="action-desc">äº‘ç«¯å®‰å…¨å¤‡ä»½</view>
          </view>
          <text class="action-arrow">â€º</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¾ç½®é€‰é¡¹ -->
  <view class="settings card">
    <view class="card-title">è®¾ç½®</view>
    
    <view class="setting-list">
      <view class="setting-item" bindtap="openPrivacySettings">
        <image class="setting-icon" src="../../assets/icons/privacy.png" />
        <view class="setting-info">
          <view class="setting-name">éšç§è®¾ç½®</view>
          <view class="setting-desc">ç®¡ç†æ•°æ®éšç§å’Œæƒé™</view>
        </view>
        <view class="setting-status">{{privacyLevel}}</view>
        <text class="setting-arrow">â€º</text>
      </view>
      
      <view class="setting-item" bindtap="openNotificationSettings">
        <image class="setting-icon" src="../../assets/icons/notification.png" />
        <view class="setting-info">
          <view class="setting-name">æé†’è®¾ç½®</view>
          <view class="setting-desc">è®°å½•æé†’å’Œæ¨é€è®¾ç½®</view>
        </view>
        <switch 
          checked="{{notificationEnabled}}" 
          bindchange="toggleNotification"
          class="setting-switch"
        />
        <text class="setting-arrow">â€º</text>
      </view>
      
      <view class="setting-item" bindtap="openThemeSettings">
        <image class="setting-icon" src="../../assets/icons/theme.png" />
        <view class="setting-info">
          <view class="setting-name">ä¸»é¢˜è®¾ç½®</view>
          <view class="setting-desc">ä¸ªæ€§åŒ–ç•Œé¢ä¸»é¢˜</view>
        </view>
        <view class="setting-status">{{currentTheme}}</view>
        <text class="setting-arrow">â€º</text>
      </view>
      
      <view class="setting-item" bindtap="openLanguageSettings">
        <image class="setting-icon" src="../../assets/icons/language.png" />
        <view class="setting-info">
          <view class="setting-name">è¯­è¨€è®¾ç½®</view>
          <view class="setting-desc">åˆ‡æ¢ç•Œé¢è¯­è¨€</view>
        </view>
        <view class="setting-status">ä¸­æ–‡</view>
        <text class="setting-arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- å¸®åŠ©ä¸åé¦ˆ -->
  <view class="help-feedback card">
    <view class="card-title">å¸®åŠ©ä¸åé¦ˆ</view>
    
    <view class="help-list">
      <view class="help-item" bindtap="viewHelp">
        <image class="help-icon" src="../../assets/icons/help.png" />
        <text class="help-text">ä½¿ç”¨å¸®åŠ©</text>
        <text class="help-arrow">â€º</text>
      </view>
      
      <view class="help-item" bindtap="contactSupport">
        <image class="help-icon" src="../../assets/icons/support.png" />
        <text class="help-text">è”ç³»å®¢æœ</text>
        <text class="help-arrow">â€º</text>
      </view>
      
      <view class="help-item" bindtap="provideFeedback">
        <image class="help-icon" src="../../assets/icons/feedback.png" />
        <text class="help-text">æ„è§åé¦ˆ</text>
        <text class="help-arrow">â€º</text>
      </view>
      
      <view class="help-item" bindtap="viewPrivacyPolicy">
        <image class="help-icon" src="../../assets/icons/policy.png" />
        <text class="help-text">éšç§æ”¿ç­–</text>
        <text class="help-arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- å…³äºåº”ç”¨ -->
  <view class="about card">
    <view class="app-info">
      <image class="app-logo" src="../../assets/icons/logo.png" />
      <view class="app-details">
        <view class="app-name">æƒ…ç»ªå°åŠ©æ‰‹</view>
        <view class="app-version">ç‰ˆæœ¬ {{appVersion}}</view>
        <view class="app-desc">è®°å½•å¿ƒæƒ…ï¼Œå…³çˆ±è‡ªå·±</view>
      </view>
    </view>
    
    <view class="app-actions">
      <button class="btn btn-outline" bindtap="checkUpdate">æ£€æŸ¥æ›´æ–°</button>
      <button class="btn btn-outline" bindtap="rateApp">ç»™ä¸ªå¥½è¯„</button>
    </view>
  </view>
</view>

<!-- ç”¨æˆ·èµ„æ–™ç¼–è¾‘å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showEditModal}}" bindtap="hideEditModal">
  <view class="modal-content edit-modal" catchtap="">
    <view class="modal-header">
      <view class="modal-title">ç¼–è¾‘èµ„æ–™</view>
      <view class="modal-close" bindtap="hideEditModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="edit-avatar">
        <image class="edit-avatar-img" src="{{editUserInfo.avatarUrl || defaultAvatar}}" />
        <button class="btn btn-outline btn-small" bindtap="changeAvatar">æ›´æ¢å¤´åƒ</button>
      </view>
      
      <view class="input-group">
        <view class="input-label">æ˜µç§°</view>
        <input 
          class="input"
          placeholder="è¯·è¾“å…¥æ˜µç§°"
          value="{{editUserInfo.nickName}}"
          bindinput="onNickNameInput"
          maxlength="20"
        />
      </view>
      
      <view class="input-group">
        <view class="input-label">ä¸ªæ€§ç­¾å</view>
        <textarea 
          class="input textarea"
          placeholder="åˆ†äº«ä¸€å¥è¯æè¿°ç°åœ¨çš„è‡ªå·±..."
          value="{{editUserInfo.signature}}"
          bindinput="onSignatureInput"
          maxlength="50"
        />
      </view>
    </view>
    <view class="modal-actions">
      <button class="btn btn-outline mr-sm" bindtap="hideEditModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="saveProfile">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- æˆå°±è¯¦æƒ…å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showAchievementModal}}" bindtap="hideAchievementModal">
  <view class="modal-content achievement-modal" catchtap="">
    <view class="modal-header">
      <view class="modal-title">æˆå°±è¯¦æƒ…</view>
      <view class="modal-close" bindtap="hideAchievementModal">Ã—</view>
    </view>
    <view class="modal-body" wx:if="{{selectedAchievement}}">
      <view class="achievement-detail">
        <image class="achievement-detail-icon" src="{{selectedAchievement.icon}}" onerror="handleImageError" />
        <view class="achievement-detail-name">{{selectedAchievement.name}}</view>
        <view class="achievement-detail-desc">{{selectedAchievement.description}}</view>
        
        <view class="achievement-progress-detail" wx:if="{{!selectedAchievement.unlocked}}">
          <view class="progress-label">è¿›åº¦</view>
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{selectedAchievement.progress}}%"
            ></view>
          </view>
          <view class="progress-text">
            {{selectedAchievement.current}}/{{selectedAchievement.target}}
          </view>
        </view>
        
        <view class="achievement-unlock-time" wx:if="{{selectedAchievement.unlocked}}">
          <text>è§£é”æ—¶é—´: {{selectedAchievement.unlockTime}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- éšç§è®¾ç½®å¼¹çª— -->
<view class="modal-overlay" wx:if="{{showPrivacyModal}}" bindtap="hidePrivacyModal">
  <view class="modal-content privacy-modal" catchtap="">
    <view class="modal-header">
      <view class="modal-title">éšç§è®¾ç½®</view>
      <view class="modal-close" bindtap="hidePrivacyModal">Ã—</view>
    </view>
    <view class="modal-body">
      <view class="privacy-options">
        <view 
          wx:for="{{privacyLevels}}" 
          wx:key="value"
          class="privacy-option {{selectedPrivacyLevel === item.value ? 'selected' : ''}}"
          bindtap="selectPrivacyLevel"
          data-level="{{item.value}}"
        >
          <view class="privacy-option-header">
            <image class="privacy-option-icon" src="{{item.icon}}" />
            <view class="privacy-option-name">{{item.name}}</view>
            <view class="privacy-radio {{selectedPrivacyLevel === item.value ? 'checked' : ''}}"></view>
          </view>
          <view class="privacy-option-desc">{{item.description}}</view>
        </view>
      </view>
    </view>
    <view class="modal-actions">
      <button class="btn btn-outline mr-sm" bindtap="hidePrivacyModal">å–æ¶ˆ</button>
      <button class="btn btn-primary" bindtap="savePrivacySettings">ä¿å­˜</button>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{isLoading}}">
  <view class="loading-content">
    <view class="loading"></view>
    <text>{{loadingText}}</text>
  </view>
</view>
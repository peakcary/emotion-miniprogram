# 情绪小程序完整部署指南

## 🎯 部署概览

本指南涵盖了从开发环境到生产环境的完整部署流程，包括云函数上传、数据库配置、权限设置和上线发布。

## 📋 部署前准备

### 1. 环境配置确认
```bash
- 小程序AppID: wxf2a1defe4093ab24
- 云环境ID: cloud1-8g0nzxjxe1f94684  
- 项目版本: 1.0.0
- 微信基础库: >= 2.10.0
```

### 2. 运行配置检查
在微信开发者工具控制台执行：
```javascript
// 复制 production-checklist.js 内容并执行
// 确保所有核心检查项通过
```

## 🚀 第一阶段：云函数部署

### 自动化部署（推荐）
```bash
cd /Users/peakom/Documents/work/emotion-miniprogram
./deploy.sh
```

### 手动部署步骤
1. **打开微信开发者工具**
   - 导入项目目录
   - 确认AppID配置正确

2. **配置云开发环境**
   - 点击工具栏"云开发"
   - 选择环境：cloud1-8g0nzxjxe1f94684
   - 等待环境初始化完成

3. **上传云函数**
   依次右键以下文件夹并选择"上传并部署：云端安装依赖"：
   ```
   cloudfunctions/user-data
   cloudfunctions/community
   cloudfunctions/emotion-analysis
   ```

4. **验证云函数**
   ```javascript
   // 在开发者工具控制台执行
   wx.cloud.callFunction({
     name: 'user-data',
     data: { action: 'getUserData' },
     success: res => console.log('✓ 云函数正常', res),
     fail: err => console.error('✗ 云函数异常', err)
   })
   ```

## 📊 第二阶段：数据库配置

### 1. 运行初始化脚本
在云开发控制台数据库页面执行 `database-init.js` 脚本

### 2. 创建数据集合
系统将自动创建以下集合：
```
- emotion_records (情绪记录)
- community_posts (社区帖子)
- user_profiles (用户资料)
- post_comments (帖子评论)
- user_achievements (用户成就)
```

### 3. 配置权限规则
为每个集合设置权限：

**emotion_records & user_profiles & user_achievements:**
```javascript
// 读权限
auth.openid == doc._openid

// 写权限  
auth.openid == doc._openid
```

**community_posts & post_comments:**
```javascript
// 读权限
true

// 写权限
auth.openid == doc._openid
```

### 4. 创建索引（可选）
为提高查询性能，建议创建索引：
```javascript
// emotion_records
{ "_openid": 1, "timestamp": -1 }

// community_posts
{ "topic": 1, "timestamp": -1 }
{ "privacy": 1, "timestamp": -1 }
```

## ⚙️ 第三阶段：功能测试

### 1. 基础功能测试
```javascript
// 复制 云函数测试.js 内容到控制台执行
// 验证所有云函数正常响应
```

### 2. 端到端测试
按以下流程测试：
```
1. 首页 → 创建情绪记录
2. 分析页 → 查看数据图表
3. 社区页 → 发布帖子和评论
4. 个人中心 → 查看用户信息和成就
```

### 3. 错误边界测试
```
1. 网络断开情况下的功能表现
2. 数据为空时的页面显示
3. 输入异常数据的处理
4. 页面间快速切换的稳定性
```

## 🎨 第四阶段：优化配置

### 1. 性能优化
- [x] 图片资源优化（已完成）
- [x] 本地数据缓存（已实现）
- [x] 错误日志管理（已配置）
- [x] Canvas渲染优化（已实现）

### 2. 安全配置
- [x] 输入验证和XSS防护
- [x] 数据库权限最小化原则
- [x] 敏感信息保护
- [x] 错误信息脱敏

### 3. 用户体验
- [x] 离线功能支持
- [x] 加载状态提示
- [x] 错误友好提示
- [x] 响应式适配

## 📱 第五阶段：小程序发布

### 1. 代码上传
```bash
1. 在微信开发者工具中点击"上传"
2. 填写版本号：1.0.0
3. 填写版本描述：情绪记录与分析小程序首版发布
4. 点击上传
```

### 2. 提交审核
在微信公众平台：
```
1. 登录 mp.weixin.qq.com
2. 进入版本管理页面
3. 找到上传的版本
4. 点击"提交审核"
5. 填写审核信息
```

### 3. 审核信息填写
```
功能介绍：
情绪记录与分析小程序，帮助用户记录日常情绪变化，
通过数据可视化和AI分析提供个性化的情绪管理建议，
支持社区分享和成就系统。

核心功能：
- 情绪记录：支持多种方式记录情绪状态
- 数据分析：图表可视化展示情绪趋势和模式
- 社区互动：用户可分享经验和相互支持
- 个人成长：成就系统激励持续使用

测试账号：无需特殊账号，支持微信登录
```

### 4. 审核要点说明
```
隐私保护：
- 用户数据主要存储在本地
- 云端数据仅用于备份和同步
- 严格的权限控制，用户只能访问自己的数据

内容安全：
- 社区内容有举报机制
- 敏感词过滤
- 匿名发布选项保护隐私

功能合规：
- 不涉及医疗诊断
- 仅提供情绪记录和分析工具
- 鼓励专业帮助的引导
```

## ✅ 第六阶段：发布上线

### 1. 审核通过后
```
1. 收到审核通过通知
2. 在微信公众平台点击"发布"
3. 小程序正式上线
```

### 2. 上线后监控
定期检查：
```
- 云函数调用日志
- 错误率和响应时间
- 用户反馈和评分
- 数据库性能指标
```

### 3. 版本迭代
后续更新流程：
```
1. 本地开发和测试
2. 运行部署检查脚本
3. 上传新版本
4. 灰度发布（可选）
5. 全量发布
```

## 🔧 故障排查

### 常见问题解决

**云函数调用失败：**
```javascript
// 检查环境ID配置
console.log(getApp().globalData.cloudEnv)

// 检查云函数状态
wx.cloud.callFunction({
  name: 'user-data',
  data: { action: 'healthCheck' }
})
```

**数据库权限错误：**
```
1. 检查集合权限设置
2. 确认用户已正确授权
3. 验证_openid字段存在
```

**图片加载失败：**
```
1. 检查图片文件是否存在
2. 验证文件路径拼写
3. 确认图片格式支持
```

**页面白屏或报错：**
```
1. 查看控制台错误日志
2. 检查页面路径配置
3. 验证数据结构完整性
```

## 📞 技术支持

如遇到部署问题：

1. **查看错误日志**：微信开发者工具控制台
2. **检查官方文档**：https://developers.weixin.qq.com/miniprogram/dev/
3. **社区求助**：微信开发者社区
4. **联系客服**：微信公众平台客服

## 📈 成功指标

部署成功的标志：
- ✅ 所有云函数状态正常
- ✅ 数据库读写功能正常
- ✅ 小程序四个页面都能正常加载
- ✅ 核心功能（记录、分析、社区、个人中心）都能使用
- ✅ 错误处理机制正常工作
- ✅ 用户可以正常登录和使用

---

🎉 **恭喜完成部署！**

现在你的情绪小程序已经准备好为用户提供专业的情绪记录和分析服务了！
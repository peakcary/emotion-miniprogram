# 情绪小程序云函数上传指南

## 云函数概览

项目包含3个云函数：

1. **user-data** - 用户数据管理云函数
2. **community** - 社区功能云函数  
3. **emotion-analysis** - 情绪分析云函数

## 上传步骤

### 前提条件
1. 确保微信开发者工具已登录
2. 云环境ID已配置：`cloud1-8g0nzxjxe1f94684`
3. 小程序AppID已配置：`wxf2a1defe4093ab24`

### 方法一：通过微信开发者工具上传（推荐）

#### 1. 打开微信开发者工具
- 导入项目：`/Users/peakom/Documents/work/emotion-miniprogram`
- 确认AppID：`wxf2a1defe4093ab24`

#### 2. 配置云开发环境
```
1. 点击工具栏中的"云开发"按钮
2. 如果是第一次使用，需要开通云开发
3. 选择环境：cloud1-8g0nzxjxe1f94684
4. 等待环境初始化完成
```

#### 3. 上传云函数
对于每个云函数执行以下步骤：

**上传 user-data 云函数：**
```
1. 在项目结构中找到 cloudfunctions/user-data
2. 右键点击 user-data 文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待上传完成（显示绿色勾号）
```

**上传 community 云函数：**
```
1. 右键点击 cloudfunctions/community
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成
```

**上传 emotion-analysis 云函数：**
```
1. 右键点击 cloudfunctions/emotion-analysis
2. 选择"上传并部署：云端安装依赖"
3. 等待上传完成
```

#### 4. 验证上传成功
```
1. 点击"云开发"控制台
2. 进入"云函数"页面
3. 确认看到3个云函数：
   - user-data (状态：正常)
   - community (状态：正常)
   - emotion-analysis (状态：正常)
```

### 方法二：通过云开发控制台上传

#### 1. 访问云开发控制台
- 登录：https://console.cloud.tencent.com/tcb
- 选择环境：cloud1-8g0nzxjxe1f94684

#### 2. 手动上传函数代码
```
1. 进入"云函数"页面
2. 点击"新建函数"
3. 函数名称：user-data
4. 运行环境：Node.js 16
5. 上传方式：本地上传zip包
6. 重复为其他两个函数
```

#### 3. 创建ZIP包
为每个云函数创建压缩包：

**user-data.zip 包含：**
```
user-data/
├── index.js
└── package.json
```

**community.zip 包含：**
```
community/
├── index.js
└── package.json
```

**emotion-analysis.zip 包含：**
```
emotion-analysis/
├── index.js
└── package.json
```

## 数据库配置

### 创建数据集合
在云开发控制台的数据库页面创建以下集合：

1. **emotion_records** - 情绪记录
```json
{
  "_id": "自动生成",
  "_openid": "用户openid",
  "emotion": {
    "name": "情绪名称",
    "emoji": "😊"
  },
  "intensity": 7,
  "description": "描述",
  "tags": ["工作", "压力"],
  "timestamp": 1703123456789,
  "location": "位置信息"
}
```

2. **community_posts** - 社区帖子
```json
{
  "_id": "自动生成",
  "_openid": "用户openid",
  "content": "帖子内容",
  "mood": "开心",
  "topic": "daily",
  "privacy": "public",
  "likes": 0,
  "comments": 0,
  "timestamp": 1703123456789
}
```

3. **user_profiles** - 用户资料
```json
{
  "_id": "自动生成",
  "_openid": "用户openid",
  "nickName": "用户昵称",
  "avatarUrl": "头像URL",
  "level": 1,
  "exp": 100,
  "achievements": [],
  "settings": {},
  "lastActive": 1703123456789
}
```

### 设置权限
对于每个集合设置权限：
```
1. 进入数据库控制台
2. 选择集合
3. 设置权限 → "所有用户可读，仅创建者可写"
```

## 云函数权限配置

### 设置访问权限
```
1. 进入云函数控制台
2. 选择函数
3. 函数配置 → 权限配置
4. 设置为"所有用户"（小程序端调用）
```

### 环境变量（可选）
如需要可以设置环境变量：
```
NODE_ENV=production
DEBUG=false
```

## 测试云函数

### 在开发者工具中测试
```javascript
// 在小程序中调用测试
wx.cloud.callFunction({
  name: 'user-data',
  data: {
    action: 'getUserData'
  },
  success: res => {
    console.log('云函数调用成功:', res)
  },
  fail: err => {
    console.error('云函数调用失败:', err)
  }
})
```

### 在控制台测试
```
1. 进入云函数控制台
2. 选择函数
3. 点击"测试"
4. 输入测试数据：
{
  "action": "getUserData",
  "data": {}
}
5. 点击"执行测试"
```

## 常见问题解决

### 1. 上传失败
```
问题：上传云函数时提示权限不足
解决：确认微信开发者工具已登录正确的微信账号，且该账号有小程序开发权限
```

### 2. 依赖安装失败
```
问题：云端安装依赖失败
解决：检查package.json中的依赖版本，建议使用稳定版本
推荐：wx-server-sdk使用 ~2.6.3 版本
```

### 3. 函数执行超时
```
问题：云函数执行超时
解决：在云函数配置中增加超时时间（最大60秒）
```

### 4. 数据库权限错误
```
问题：访问数据库提示权限不足
解决：检查数据库集合权限设置，确保设置为正确的权限模式
```

## 上传后验证清单

- [ ] 3个云函数都显示"正常"状态
- [ ] 数据库集合创建完成
- [ ] 权限配置正确
- [ ] 在小程序中测试调用成功
- [ ] 查看云函数日志无错误

## 重要提醒

1. **环境一致性**：确保本地开发环境ID与线上环境ID一致
2. **权限最小化**：只给云函数必要的权限
3. **日志监控**：定期查看云函数执行日志
4. **备份重要**：上传前备份本地代码

---

## 快速上传命令

如果你熟悉微信开发者工具，可以使用以下快速步骤：

```bash
# 1. 确保项目在微信开发者工具中正确打开
# 2. 依次右键每个云函数文件夹执行：
#    - user-data → "上传并部署：云端安装依赖"
#    - community → "上传并部署：云端安装依赖"  
#    - emotion-analysis → "上传并部署：云端安装依赖"
# 3. 等待上传完成，查看云开发控制台确认
```

上传完成后，小程序的云函数功能就可以正常使用了！